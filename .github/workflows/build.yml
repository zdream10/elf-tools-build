name: Build elf-tools (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkgconf
            git
            flex
            bison

      - name: Clone nunuhara/elf-tools (fix submodule URL to HTTPS)
        shell: msys2 {0}
        run: |
          set -e
          # 1) 克隆主仓库（不递归子模块）
          git clone https://github.com/nunuhara/elf-tools.git
          cd elf-tools

          # 2) 将 .gitmodules 中的 SSH 地址改为 HTTPS（防止 Host key 验证失败）
          if [ -f .gitmodules ]; then
            sed -i 's#git@github.com:#https://github.com/#g' .gitmodules
            git submodule sync --recursive
          fi

          # 3) 初始化 + 更新子模块（此时使用 HTTPS）
          git submodule update --init --recursive

          # 4) 构建
          meson setup build --buildtype=release
          ninja -C build

      - name: Pack artifact (exe + README + SHA256)
        shell: bash
        run: |
          set -e
          mkdir -p out
          cp elf-tools/build/elf.exe out/
          cp elf-tools/README.md out/
          cd out
          # 生成带 commit 短哈希的文件名
          COMMIT=$(git -C ../elf-tools rev-parse --short HEAD)
          mv elf.exe "elf_${COMMIT}.exe"
          # 生成 SHA256 校验
          certutil -hashfile "elf_${COMMIT}.exe" SHA256 > SHA256.txt 2>&1 || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: elf-tools-windows
          path: out
